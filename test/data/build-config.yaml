apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: my-csi-bc-s2i
  namespace: builds-test
spec:
  runPolicy: Serial
  source:
    dockerfile: |
      FROM registry.access.redhat.com/UBI/ubi:latest
      RUN ls -la /etc/pki/entitlement &&\
          yum install -y yum-utils
      RUN CMD
      RUN subscription-manager repos --enable=fast-datapath-for-rhel-UBINUM-x86_64-rpms
      RUN cat repo.txt | xargs -I {} subscription-manager repos --enable={}
      RUN cat repo.txt | xargs -I {} dnf config-manager --save --setopt=*.module_hotfixes=1 {}
      ## RUN cat repo.txt | xargs -I {} repoquery pkgnarrowstr --quiet --all --repoid={} >> packages.txt
      RUN echo -e "cri-o\nrunc\ncri-o-debuginfo\ncrun-debuginfo" >> packages.txt
      RUN shuf -n 3 packages.txt > installed_pck &&\
          cat installed_pck 
      RUN cat installed_pck | xargs -I {} INSTALL_CMD
  strategy:
    type: Docker
    dockerStrategy:
      volumes:
        - mounts:
            - destinationPath: "/etc/pki/entitlement"
          name: my-csi-shared-secret
          source:
            csi:
              driver: csi.sharedresource.openshift.io
              readOnly: true
              volumeAttributes:
                sharedSecret: my-share 
            type: CSI
  output:
    to:
      kind: "ImageStreamTag"
      name: "sample-custom:latest"
